<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>pDAI Price+Time Lock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050815;
      color: #f3f4f6;
      margin: 0;
      padding: 16px;
    }
    h1, h2 { margin-top: 0; }
    .card {
      background: #0b1020;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .row { display: flex; flex-wrap: wrap; gap: 16px; }
    .col { flex: 1 1 280px; }
    input, button {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      font-size: 14px;
    }
    input[type="datetime-local"] { color-scheme: dark; }
    button {
      cursor: pointer;
      border: none;
      background: #16a34a;
      font-weight: 600;
    }
    button[disabled] { opacity: 0.5; cursor: not-allowed; }
    label { display: block; margin-bottom: 4px; font-size: 13px; color: #9ca3af; }
    .field { margin-bottom: 12px; }
    .small { font-size: 12px; color: #9ca3af; }
    .tag {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      font-size: 11px; background: #111827; border: 1px solid #1f2937;
      margin-right: 6px; margin-top: 4px;
    }
    .status-ok { color: #4ade80; }
    .status-warn { color: #facc15; }
    .status-bad { color: #f87171; }
    .mono { font-family: monospace; font-size: 12px; }
  </style>
</head>
<body>
  <h1>pDAI Price + Time Lock</h1>

  <div class="card">
    <button id="connectBtn">Connect Wallet</button>
    <span id="walletAddress" class="mono"></span>
    <div class="small" id="networkInfo"></div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2>Create New Lock</h2>
        <form id="createForm">
          <div class="field">
            <label for="targetPrice">Target price (DAI per 1 pDAI)</label>
            <input id="targetPrice" type="text" placeholder="e.g. 0.0100" required />
          </div>

          <div class="field">
            <label for="unlockDateTime">Backup unlock date &amp; time</label>
            <input id="unlockDateTime" type="datetime-local" required />
          </div>

          <button type="submit" id="createBtn">Create Vault</button>
          <div class="small" id="createStatus"></div>
        </form>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h2>Global Price Feed</h2>
        <div id="globalPrice" style="margin-top:8px;font-size:14px;"></div>
        <div class="small" id="globalPriceRaw"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Your Locks</h2>
    <div id="locksContainer" class="small">Connect your wallet to load locks.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

  <script>
    (function () {

      // -----------------------------
      // ðŸ”¥ YOUR REAL ADDRESSES
      // -----------------------------
      const FACTORY_ADDRESS = "0xaA5866aAA1184730Dd2926Ed83aCCbD89F128d1d";

      // pDAI (checksummed)
      const PDAI_ADDRESS = "0x6B175474E89094C44Da98B954EedeAC495271d0F";

      // â— TODO: replace this placeholder with the correct DAI contract
      const DAI_ADDRESS = "0xefd766ccb38eaf1dfd701853bfce31359239f305";

      // PulseX pDAI/DAI pair
      const PAIR_ADDRESS = "0x1D2be6eFf95Ac5C380a8D6a6143b6a97dd9D8712";


      // -----------------------------
      // ABIs
      // -----------------------------
      const factoryAbi = [
        "event VaultCreated(address indexed owner, address vault, uint256 priceThreshold1e18, uint256 unlockTime)",
        "function createVault(uint256 priceThreshold1e18, uint256 unlockTime) external returns (address)"
      ];

      const vaultAbi = [
        "function owner() view returns (address)",
        "function priceThreshold() view returns (uint256)",
        "function unlockTime() view returns (uint256)",
        "function withdrawn() view returns (bool)",
        "function currentPricePDAIinDAI() view returns (uint256)",
        "function canWithdraw() view returns (bool)",
        "function withdraw() external"
      ];

      const pairAbi = [
        "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)"
      ];

      const erc20Abi = [
        "function balanceOf(address) view returns (uint256)"
      ];


      // -----------------------------
      // STATE
      // -----------------------------
      let provider, signer, address;
      let factory, pdai, pairContract;
      let locks = [];
      let countdownInterval;


      // -----------------------------
      // UI ELEMENTS
      // -----------------------------
      const connectBtn = document.getElementById("connectBtn");
      const walletSpan = document.getElementById("walletAddress");
      const networkInfo = document.getElementById("networkInfo");
      const createForm = document.getElementById("createForm");
      const targetPriceInput = document.getElementById("targetPrice");
      const unlockDateTimeInput = document.getElementById("unlockDateTime");
      const createStatus = document.getElementById("createStatus");
      const createBtn = document.getElementById("createBtn");
      const locksContainer = document.getElementById("locksContainer");
      const globalPriceDiv = document.getElementById("globalPrice");
      const globalPriceRawDiv = document.getElementById("globalPriceRaw");


      // -----------------------------
      // CONNECT WALLET (fixed ENS issue)
      // -----------------------------
      async function connect() {
        try {
          if (!window.ethereum) {
            alert("No injected wallet found.");
            return;
          }
      
          // Create provider normally (no options allowed)
          provider = new ethers.BrowserProvider(window.ethereum);
      
          // FIX #1: Override network detection (bypass ENS requirement)
          provider._network = {
            name: "pulsechain",
            chainId: 369
          };
      
          // FIX #2: Disable ENS resolution entirely
          provider._detectNetwork = async () => provider._network;
      
          // Request accounts
          await provider.send("eth_requestAccounts", []);
          signer = await provider.getSigner();
          address = await signer.getAddress();
      
          walletSpan.textContent = address;
          networkInfo.textContent = `Connected to PulseChain (chainId 369)`;
      
          factory = new ethers.Contract(FACTORY_ADDRESS, factoryAbi, signer);
          pdai = new ethers.Contract(PDAI_ADDRESS, erc20Abi, provider);
          pairContract = new ethers.Contract(PAIR_ADDRESS, pairAbi, provider);
      
          await refreshGlobalPrice();
          await loadUserLocks();
      
          if (countdownInterval) clearInterval(countdownInterval);
          countdownInterval = setInterval(updateCountdowns, 1000);
      
        } catch (err) {
          console.error(err);
          alert("Connection failed: " + err.message);
        }
      }



      // -----------------------------
      // GLOBAL PRICE FEED
      // -----------------------------
      async function refreshGlobalPrice() {
        try {
          const [r0, r1] = await pairContract.getReserves();
          if (r0 === 0n || r1 === 0n) {
            globalPriceDiv.textContent = "No liquidity in pDAI/DAI pair.";
            return;
          }
          const price1e18 = (r1 * 10n ** 18n) / r0;
          const priceFloat = Number(price1e18) / 1e18;

          globalPriceDiv.textContent = `1 pDAI â‰ˆ ${priceFloat.toFixed(6)} DAI`;
          globalPriceRawDiv.textContent = `raw: ${price1e18}`;
        } catch (err) {
          console.error(err);
        }
      }


      // -----------------------------
      // CREATE NEW VAULT
      // -----------------------------
      async function handleCreate(e) {
        e.preventDefault();
        if (!factory) return alert("Connect wallet first.");

        try {
          createBtn.disabled = true;
          createStatus.textContent = "Sending transactionâ€¦";

          const rawPrice = targetPriceInput.value.trim();
          const ts = unlockDateTimeInput.value;

          const threshold1e18 = ethers.parseUnits(rawPrice, 18);
          const unlockTime = Math.floor(new Date(ts).getTime() / 1000);

          const tx = await factory.createVault(threshold1e18, unlockTime);
          const receipt = await tx.wait();

          createStatus.textContent = "Vault created.";
          await loadUserLocks();
        } catch (err) {
          console.error(err);
          createStatus.textContent = "Error: " + err.message;
        } finally {
          createBtn.disabled = false;
        }
      }


      // -----------------------------
      // LOAD USER LOCKS
      // -----------------------------
      async function loadU
